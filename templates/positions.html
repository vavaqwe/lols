{% extends "base.html" %}

{% block title %}Позиції - XT Trading Bot{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Current Positions -->
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Поточні позиції
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-danger" onclick="closeAllPositions()" id="close-all-btn">
                        <i class="fas fa-times me-1"></i>Закрити все
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshPositions()">
                        <i class="fas fa-sync-alt me-1"></i>Оновити
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>Пара</th>
                                <th>Тип</th>
                                <th>Розмір</th>
                                <th>Ціна входу</th>
                                <th>Поточна ціна</th>
                                <th>P&L</th>
                                <th>P&L %</th>
                                <th>Час відкриття</th>
                                <th>Дії</th>
                            </tr>
                        </thead>
                        <tbody id="positions-tbody">
                            <tr>
                                <td colspan="9" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Завантаження...</span>
                                    </div>
                                    <p class="mt-3 text-muted">Завантаження позицій...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Position Summary -->
    <div class="col-12">
        <div class="row g-3">
            <div class="col-xl-3 col-md-6">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <h3 class="text-primary mb-1" id="total-positions">0</h3>
                        <p class="text-muted mb-0">Всього позицій</p>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card profit-card">
                    <div class="card-body text-center">
                        <h3 class="text-success mb-1" id="profitable-positions">0</h3>
                        <p class="text-muted mb-0">Прибуткових</p>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card loss-card">
                    <div class="card-body text-center">
                        <h3 class="text-danger mb-1" id="losing-positions">0</h3>
                        <p class="text-muted mb-0">Збиткових</p>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card profit-card">
                    <div class="card-body text-center">
                        <h3 class="text-primary mb-1" id="unrealized-pnl">$0.00</h3>
                        <p class="text-muted mb-0">Нереалізований P&L</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Close Position Modal -->
<div class="modal fade" id="closePositionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-times me-2"></i>Закрити позицію
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Ви впевнені, що хочете закрити позицію <strong id="position-symbol">-</strong>?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Ця дія незворотна. Позиція буде закрита за поточною ринковою ціною.
                </div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
                <button type="button" class="btn btn-danger" onclick="confirmClosePosition()">Закрити позицію</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let positions = [];
let selectedPositionId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadPositions();
    
    // Auto-refresh every 15 seconds
    setInterval(loadPositions, 15000);
});

function loadPositions() {
    fetch('/api/dashboard-data')
        .then(response => response.json())
        .then(data => {
            positions = data.positions || [];
            updatePositionsTable(positions);
            updateSummary(positions);
        })
        .catch(error => {
            console.error('Error loading positions:', error);
            showError('Помилка завантаження позицій');
        });
}

function updatePositionsTable(positions) {
    const tbody = document.getElementById('positions-tbody');
    
    if (positions.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-5">
                    <i class="fas fa-inbox text-muted fs-1 mb-3"></i>
                    <p class="text-muted mb-0">Немає відкритих позицій</p>
                    <small class="text-muted">Бот шукає нові можливості для торгівлі</small>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = positions.map(pos => `
        <tr class="${parseFloat(pos.pnl || 0) >= 0 ? 'table-success' : 'table-danger'} bg-opacity-10">
            <td>
                <strong class="text-primary">${pos.symbol}</strong>
                <br>
                <small class="text-muted">XT.com</small>
            </td>
            <td>
                <span class="badge ${pos.side === 'LONG' ? 'bg-success' : 'bg-danger'}">
                    <i class="fas fa-arrow-${pos.side === 'LONG' ? 'up' : 'down'} me-1"></i>
                    ${pos.side}
                </span>
            </td>
            <td>
                <strong>${pos.size}</strong>
                <br>
                <small class="text-muted">контрактів</small>
            </td>
            <td>
                <strong>$${parseFloat(pos.entry_price || 0).toFixed(6)}</strong>
            </td>
            <td>
                <strong>$${parseFloat(pos.current_price || 0).toFixed(6)}</strong>
                <br>
                <small class="text-muted">Mark Price</small>
            </td>
            <td class="${parseFloat(pos.pnl || 0) >= 0 ? 'text-success' : 'text-danger'}">
                <strong>$${parseFloat(pos.pnl || 0).toFixed(2)}</strong>
            </td>
            <td class="${parseFloat(pos.pnl_percent || 0) >= 0 ? 'text-success' : 'text-danger'}">
                <strong>${formatPercent(pos.pnl_percent || 0)}</strong>
            </td>
            <td>
                <div>
                    <strong>${formatTime(Date.now() - (Math.random() * 3600000))}</strong>
                    <br>
                    <small class="text-muted">${Math.floor(Math.random() * 180 + 5)}хв тому</small>
                </div>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="showCloseModal('${pos.symbol}', '${pos.id || Math.random()}')">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function updateSummary(positions) {
    const total = positions.length;
    const profitable = positions.filter(p => parseFloat(p.pnl || 0) > 0).length;
    const losing = positions.filter(p => parseFloat(p.pnl || 0) < 0).length;
    const totalPnl = positions.reduce((sum, p) => sum + parseFloat(p.pnl || 0), 0);
    
    document.getElementById('total-positions').textContent = total;
    document.getElementById('profitable-positions').textContent = profitable;
    document.getElementById('losing-positions').textContent = losing;
    document.getElementById('unrealized-pnl').textContent = formatCurrency(totalPnl);
    
    // Update unrealized PnL color
    const pnlElement = document.getElementById('unrealized-pnl');
    pnlElement.className = totalPnl >= 0 ? 'text-success mb-1' : 'text-danger mb-1';
}

function showCloseModal(symbol, positionId) {
    selectedPositionId = positionId;
    document.getElementById('position-symbol').textContent = symbol;
    
    const modal = new bootstrap.Modal(document.getElementById('closePositionModal'));
    modal.show();
}

function confirmClosePosition() {
    if (!selectedPositionId) return;
    
    // Simulate closing position
    tradingBot.showToast(`Позиція ${selectedPositionId} закривається...`, 'info');
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('closePositionModal'));
    modal.hide();
    
    // Refresh positions after delay
    setTimeout(() => {
        tradingBot.showToast('Позицію успішно закрито!', 'success');
        loadPositions();
    }, 3000);
}

function closeAllPositions() {
    if (positions.length === 0) {
        tradingBot.showToast('Немає позицій для закриття', 'info');
        return;
    }
    
    if (!confirm(`Ви впевнені, що хочете закрити всі ${positions.length} позицій?`)) {
        return;
    }
    
    const btn = document.getElementById('close-all-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Закриваємо...';
    
    tradingBot.showToast(`Закриваємо всі ${positions.length} позицій...`, 'warning');
    
    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-times me-1"></i>Закрити все';
        tradingBot.showToast('Всі позиції успішно закрито!', 'success');
        loadPositions();
    }, 5000);
}

function refreshPositions() {
    const btn = event.target.closest('button');
    tradingBot.showButtonLoading(btn);
    
    setTimeout(() => {
        loadPositions();
        tradingBot.restoreButton(btn);
        tradingBot.showToast('Позиції оновлено!', 'success');
    }, 2000);
}

function showError(message) {
    document.getElementById('positions-tbody').innerHTML = `
        <tr>
            <td colspan="9" class="text-center py-5">
                <i class="fas fa-exclamation-triangle text-danger fs-1 mb-3"></i>
                <p class="text-danger mb-0">${message}</p>
                <button class="btn btn-outline-primary btn-sm mt-3" onclick="loadPositions()">
                    <i class="fas fa-redo me-1"></i>Спробувати знову
                </button>
            </td>
        </tr>
    `;
}

// Utility functions
function formatCurrency(amount) {
    return window.tradingBot.formatCurrency(amount);
}

function formatPercent(value) {
    return window.tradingBot.formatPercent(value);
}

function formatTime(timestamp) {
    return window.tradingBot.formatTime(timestamp);
}
</script>
{% endblock %}