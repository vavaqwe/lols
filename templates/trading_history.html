{% extends "base.html" %}

{% block title %}Історія торгів - XT Trading Bot{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Header with filters -->
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">Період</label>
                        <select class="form-select" id="periodFilter">
                            <option value="today">Сьогодні</option>
                            <option value="week" selected>Тиждень</option>
                            <option value="month">Місяць</option>
                            <option value="all">Весь час</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Торгова пара</label>
                        <select class="form-select" id="symbolFilter">
                            <option value="">Всі пари</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Статус</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">Всі статуси</option>
                            <option value="CLOSED">Закриті</option>
                            <option value="OPEN">Відкриті</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" onclick="applyFilters()">
                            <i class="fas fa-filter me-1"></i>Застосувати
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trading Summary -->
    <div class="col-12">
        <div class="row g-3">
            <div class="col-xl-3 col-md-6">
                <div class="card profit-card">
                    <div class="card-body text-center">
                        <h3 class="text-success mb-1" id="total-trades-count">0</h3>
                        <p class="text-muted mb-0">Всього угод</p>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <h3 class="text-success mb-1" id="winning-trades">0</h3>
                        <p class="text-muted mb-0">Прибуткових</p>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card loss-card">
                    <div class="card-body text-center">
                        <h3 class="text-danger mb-1" id="losing-trades">0</h3>
                        <p class="text-muted mb-0">Збиткових</p>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card profit-card">
                    <div class="card-body text-center">
                        <h3 class="text-primary mb-1" id="net-profit">$0.00</h3>
                        <p class="text-muted mb-0">Чистий прибуток</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trading History Table -->
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Історія торгів
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-success" onclick="exportToCSV()">
                        <i class="fas fa-download me-1"></i>Експорт
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshHistory()">
                        <i class="fas fa-sync-alt me-1"></i>Оновити
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover" id="history-table">
                        <thead class="table-primary">
                            <tr>
                                <th>Час відкриття</th>
                                <th>Пара</th>
                                <th>Тип</th>
                                <th>Розмір</th>
                                <th>Ціна входу</th>
                                <th>Ціна виходу</th>
                                <th>P&L</th>
                                <th>P&L %</th>
                                <th>Статус</th>
                                <th>Дії</th>
                            </tr>
                        </thead>
                        <tbody id="history-tbody">
                            <tr>
                                <td colspan="10" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Завантаження...</span>
                                    </div>
                                    <p class="mt-3 text-muted">Завантаження історії торгів...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav aria-label="Навігація по сторінках" class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination will be generated by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Trade Details Modal -->
    <div class="modal fade" id="tradeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-line me-2"></i>Деталі торгу
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="trade-modal-body">
                    <!-- Trade details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let totalPages = 1;
let currentFilters = {};

document.addEventListener('DOMContentLoaded', function() {
    loadTradingHistory();
    loadSymbols();
    
    // Set up filter change listeners
    ['periodFilter', 'symbolFilter', 'statusFilter'].forEach(id => {
        document.getElementById(id).addEventListener('change', applyFilters);
    });
});

function loadTradingHistory(page = 1) {
    currentPage = page;
    const filters = getCurrentFilters();
    
    showLoading();
    
    fetch(`/api/trading-history?page=${page}&${new URLSearchParams(filters)}`)
        .then(response => response.json())
        .then(data => {
            updateHistoryTable(data.trades || []);
            updateSummary(data.summary || {});
            updatePagination(data.pagination || {});
        })
        .catch(error => {
            console.error('Error loading trading history:', error);
            showError('Помилка завантаження історії торгів');
        });
}

function getCurrentFilters() {
    return {
        period: document.getElementById('periodFilter').value,
        symbol: document.getElementById('symbolFilter').value,
        status: document.getElementById('statusFilter').value
    };
}

function applyFilters() {
    currentFilters = getCurrentFilters();
    loadTradingHistory(1);
}

function updateHistoryTable(trades) {
    const tbody = document.getElementById('history-tbody');
    
    if (trades.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center py-5">
                    <i class="fas fa-inbox text-muted fs-1 mb-3"></i>
                    <p class="text-muted mb-0">Торгів не знайдено</p>
                    <small class="text-muted">Спробуйте змінити фільтри</small>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = trades.map(trade => `
        <tr>
            <td>
                <div>
                    <strong>${formatDate(trade.opened_at)}</strong>
                    <br>
                    <small class="text-muted">${formatTime(trade.opened_at)}</small>
                </div>
            </td>
            <td>
                <strong class="text-primary">${trade.symbol}</strong>
                <br>
                <small class="text-muted">XT.com</small>
            </td>
            <td>
                <span class="badge ${trade.side === 'LONG' ? 'bg-success' : 'bg-danger'}">
                    ${trade.side}
                </span>
            </td>
            <td>${trade.size || '-'}</td>
            <td>
                <strong>$${parseFloat(trade.entry_price || 0).toFixed(4)}</strong>
            </td>
            <td>
                ${trade.exit_price ? '<strong>$' + parseFloat(trade.exit_price).toFixed(4) + '</strong>' : '-'}
            </td>
            <td class="${parseFloat(trade.pnl || 0) >= 0 ? 'text-success' : 'text-danger'}">
                <strong>${formatCurrency(trade.pnl || 0)}</strong>
            </td>
            <td class="${parseFloat(trade.pnl_percent || 0) >= 0 ? 'text-success' : 'text-danger'}">
                <strong>${formatPercent(trade.pnl_percent || 0)}</strong>
            </td>
            <td>
                <span class="badge ${getStatusBadgeClass(trade.status)}">
                    ${trade.status || 'OPEN'}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-info" onclick="showTradeDetails('${trade.id}')">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function updateSummary(summary) {
    document.getElementById('total-trades-count').textContent = summary.total_trades || 0;
    document.getElementById('winning-trades').textContent = summary.winning_trades || 0;
    document.getElementById('losing-trades').textContent = summary.losing_trades || 0;
    document.getElementById('net-profit').textContent = formatCurrency(summary.net_profit || 0);
}

function updatePagination(pagination) {
    totalPages = pagination.total_pages || 1;
    const paginationEl = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        paginationEl.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadTradingHistory(${currentPage - 1})">Попередня</a>
        </li>
    `;
    
    // Page numbers
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        paginationHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadTradingHistory(${i})">${i}</a>
            </li>
        `;
    }
    
    // Next button
    paginationHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadTradingHistory(${currentPage + 1})">Наступна</a>
        </li>
    `;
    
    paginationEl.innerHTML = paginationHTML;
}

function loadSymbols() {
    fetch('/api/trading-symbols')
        .then(response => response.json())
        .then(symbols => {
            const select = document.getElementById('symbolFilter');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">Всі пари</option>' +
                symbols.map(symbol => `<option value="${symbol}">${symbol}</option>`).join('');
            
            select.value = currentValue;
        })
        .catch(error => console.error('Error loading symbols:', error));
}

function showTradeDetails(tradeId) {
    fetch(`/api/trade-details/${tradeId}`)
        .then(response => response.json())
        .then(trade => {
            displayTradeDetails(trade);
            const modal = new bootstrap.Modal(document.getElementById('tradeModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading trade details:', error);
            tradingBot.showToast('Помилка завантаження деталей торгу', 'danger');
        });
}

function displayTradeDetails(trade) {
    const modalBody = document.getElementById('trade-modal-body');
    
    modalBody.innerHTML = `
        <div class="row g-4">
            <div class="col-md-6">
                <h6 class="text-primary">Основна інформація</h6>
                <table class="table table-dark table-sm">
                    <tr>
                        <td>ID торгу:</td>
                        <td><code>${trade.id}</code></td>
                    </tr>
                    <tr>
                        <td>Торгова пара:</td>
                        <td><strong>${trade.symbol}</strong></td>
                    </tr>
                    <tr>
                        <td>Тип позиції:</td>
                        <td><span class="badge ${trade.side === 'LONG' ? 'bg-success' : 'bg-danger'}">${trade.side}</span></td>
                    </tr>
                    <tr>
                        <td>Розмір:</td>
                        <td>${trade.size}</td>
                    </tr>
                    <tr>
                        <td>Леверидж:</td>
                        <td>${trade.leverage || '1x'}</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="text-primary">Ціни та P&L</h6>
                <table class="table table-dark table-sm">
                    <tr>
                        <td>Ціна входу:</td>
                        <td><strong>$${parseFloat(trade.entry_price || 0).toFixed(4)}</strong></td>
                    </tr>
                    <tr>
                        <td>Ціна виходу:</td>
                        <td>${trade.exit_price ? '<strong>$' + parseFloat(trade.exit_price).toFixed(4) + '</strong>' : '-'}</td>
                    </tr>
                    <tr>
                        <td>P&L:</td>
                        <td class="${parseFloat(trade.pnl || 0) >= 0 ? 'text-success' : 'text-danger'}">
                            <strong>${formatCurrency(trade.pnl || 0)}</strong>
                        </td>
                    </tr>
                    <tr>
                        <td>P&L %:</td>
                        <td class="${parseFloat(trade.pnl_percent || 0) >= 0 ? 'text-success' : 'text-danger'}">
                            <strong>${formatPercent(trade.pnl_percent || 0)}</strong>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="col-12">
                <h6 class="text-primary">Часові мітки</h6>
                <table class="table table-dark table-sm">
                    <tr>
                        <td>Відкрито:</td>
                        <td><strong>${formatDate(trade.opened_at)}</strong></td>
                    </tr>
                    <tr>
                        <td>Закрито:</td>
                        <td>${trade.closed_at ? '<strong>' + formatDate(trade.closed_at) + '</strong>' : '-'}</td>
                    </tr>
                    <tr>
                        <td>Тривалість:</td>
                        <td>${trade.duration || '-'}</td>
                    </tr>
                </table>
            </div>
        </div>
    `;
}

function getStatusBadgeClass(status) {
    const classes = {
        'OPEN': 'bg-primary',
        'CLOSED': 'bg-success',
        'CANCELLED': 'bg-secondary',
        'FAILED': 'bg-danger'
    };
    return classes[status] || 'bg-secondary';
}

function refreshHistory() {
    loadTradingHistory(currentPage);
}

function exportToCSV() {
    const filters = getCurrentFilters();
    const url = `/api/export-trading-history?${new URLSearchParams(filters)}`;
    window.open(url, '_blank');
}

function showLoading() {
    document.getElementById('history-tbody').innerHTML = `
        <tr>
            <td colspan="10" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Завантаження...</span>
                </div>
                <p class="mt-3 text-muted">Завантаження історії торгів...</p>
            </td>
        </tr>
    `;
}

function showError(message) {
    document.getElementById('history-tbody').innerHTML = `
        <tr>
            <td colspan="10" class="text-center py-5">
                <i class="fas fa-exclamation-triangle text-danger fs-1 mb-3"></i>
                <p class="text-danger mb-0">${message}</p>
                <button class="btn btn-outline-primary btn-sm mt-3" onclick="refreshHistory()">
                    <i class="fas fa-redo me-1"></i>Спробувати знову
                </button>
            </td>
        </tr>
    `;
}

// Use utility functions from main.js
function formatCurrency(amount) {
    return window.tradingBot.formatCurrency(amount);
}

function formatPercent(value) {
    return window.tradingBot.formatPercent(value);
}

function formatDate(timestamp) {
    return window.tradingBot.formatDate(timestamp);
}

function formatTime(timestamp) {
    return window.tradingBot.formatTime(timestamp);
}
</script>
{% endblock %}